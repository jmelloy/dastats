<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DeviantArt Statistics</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://unpkg.com/htmx.org"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand" href="/">DeviantArt Statistics</a>
      </div>
      <div class="container-fluid">
        <div class="navbar-nav ms-auto">
          <div class="nav-item dropdown me-3">
            <select class="form-select" id="gallerySelect">
              <option value="all">All Galleries</option>
            </select>
            <script>
              fetch('/get-gallery-data')
                .then(response => response.json())
                .then(data => {
                  const select = document.getElementById('gallerySelect');
                  data.data.forEach(gallery => {
                    const option = document.createElement('option');
                    option.value = gallery.folderid;
                    option.textContent = gallery.name;
                    select.appendChild(option);
                  });
                });
            </script>
          </div>
          <div class="nav-item me-3">
            <input type="text" class="form-control" id="startDate" placeholder="Start Date">
          </div>
          <div class="nav-item">
            <input type="text" class="form-control" id="endDate" placeholder="End Date">
          </div>
        </div>
      </div>
      <script>
        flatpickr("#startDate", {
          enableTime: false,
          dateFormat: "Y-m-d",
          onChange: function(date) {
            updateTable();
          }
        });
        flatpickr("#endDate", {
          enableTime: false, 
          dateFormat: "Y-m-d",
          onChange: function(date) {
            updateTable();
          }
        });
      </script>
    </nav>


    <div class="container mt-8">
      <div class="row">
        <div class="col-md-12">
          <h2 class="text-center">Deviations by Publication Date</h2>
          <canvas id="publicationChart" style="width: 100%; height: 200px;"></canvas>
          <script>
            document.addEventListener("DOMContentLoaded", () => {
              fetch("/get-publication-data")
                .then((response) => response.json())
                .then((data) => {
                  // Fill in any missing dates with 0 counts
                  const firstDate = new Date(data.data[0].date);
                  const today = new Date();
                  const filledData = [];
                  
                  let currentDate = new Date(firstDate);
                  while (currentDate <= today) {
                    const existingData = data.data.find(
                      d => new Date(d.date).toDateString() === currentDate.toDateString()
                    );
                    
                    filledData.push({
                      date: currentDate.toISOString().split('T')[0],
                      count: existingData ? existingData.deviations : 0,
                      favorites: existingData ? existingData.favorites : 0
                    });
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                  }
                  
                  data.data = filledData;
                  new Chart("publicationChart", {
                    type: "bar",
                    data: {
                      labels: data.data.map((d) =>
                        new Date(d.date).toLocaleDateString()
                      ),
                      datasets: [
                        {
                          label: "Number of Deviations",
                          data: data.data.map((d) => d.count),
                          backgroundColor: "rgba(54, 162, 235, 0.5)",
                          borderColor: "rgba(54, 162, 235, 1)",
                        },
                        {
                          label: "Number of Favorites",
                          data: data.data.map((d) => d.favorites),
                          backgroundColor: "rgba(255, 159, 64, 0.5)",
                          borderColor: "rgba(255, 159, 64, 1)",
                        },
                      ],
                    },
                    options: {
                      responsive: false,
                      maintainAspectRatio: false,
                      scales: { y: { beginAtZero: true } },
                    },
                  });
                });
            });
          </script>
        </div>
      </div>

  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title">Top Deviations</h5>
          <div style="float: right; font-size: 0.8em;">
            <label for="limitSelect">Show top:</label>
            <select class="form-control" id="limitSelect" onchange="updateTable()">
              <option value="10" selected>10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
          
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Thumbnail</th>
                  <th>Title</th>
                  <th>Favorites</th>
                </tr>
              </thead>
              <tbody id="deviationTable">
                <!-- Table content will be populated dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Function to update the table
    function updateTable() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const limit = document.getElementById('limitSelect').value;

      // Show loading spinner while fetching data
      document.getElementById('deviationTable').innerHTML = `
        <tr>
          <td colspan="3" class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </td>
        </tr>
      `;

      fetch('/update-table', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `start_date=${startDate}&end_date=${endDate}&limit=${limit}`
      })
      .then(response => response.text())
      .then(html => {
        document.getElementById('deviationTable').innerHTML = html;
      });
    }

    // Initial load
    updateTable();

    // Update every 5 minutes
    setInterval(updateTable, 300000);
  </script>

  </body>
</html>
